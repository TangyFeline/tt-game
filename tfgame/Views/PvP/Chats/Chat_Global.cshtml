@{
    ViewBag.Title = "Chat";
}

<nav class="navbar navbar-default outsideContainer navbarTT2">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-2">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-2">
            <ul class="nav navbar-nav">
                <li>@Html.ActionLink("Back to game", "Play", "PvP")</li>
                <li>
                    @Html.ActionLink("Global", "Chat", "PvP", new { room = "global" }, null)
                </li>
                <li>
                    @Html.ActionLink("RP Room 1", "Chat", "PvP", new { room = "rp1" }, null)
                </li>
                <li>
                    @Html.ActionLink("RP Room 2", "Chat", "PvP", new { room = "rp2" }, null)
                </li>
                <li>@Html.ActionLink("RP Room 3", "Chat", "PvP", new { room = "rp3" }, null)</li>
                <li>
                    @Html.ActionLink("Create/Join Private Room", "PrivateChat", "PvP")
                </li>
                <li>
                    @Html.ActionLink("Chat Log", "ChatLog", "PvP", new { room = "global", filter = "lasth" }, new { target = "_blank" })
                </li>
                <li>@Html.ActionLink("Commands", "ChatCommands", "PvP", null, new { target = "_blank" })</li>
</ul>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>

<p class="infoMessage error" id="disconnected" style="display: none;">Your chat is currently disconnected from the server.  It will attempt to automatically reconnect.</p>

<div class="containerInner">
    <ul id="discussion"></ul>
    <div class="roomName">Room:  @ViewBag.ChatName <span id="autoScrollToggle">Autoscroll ON</span></div>
    <input type="text" id="message" maxlength="500" class="chatInput" />
    <input type="button" id="sendmessage" value="Send" style="width: 50%; padding: 6px; margin-left: auto; margin-right: auto; display: block;" />
    <input type="hidden" id="displayname" />
</div>
     @section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.0.3.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>

        var clear = true;
        var unreadCount = 0;

        var myname = "@Html.Raw(TempData["MyName"])";
        var mynameColor = "@Html.Raw(TempData["YourNameColor"])";

        var myVar = setInterval(function () { myTimer() }, 3000);
        var autoScrollEnabled = true;

        $("#autoScrollToggle").click(function () {
            if (autoScrollEnabled == true) {
                autoScrollEnabled = false;
                $(this).text("Autoscroll OFF");
            } else {
                autoScrollEnabled = true;
                $(this).text("Autoscroll ON");
            }
        });

        function myTimer() {
            clear = true;
        }

        function chatLink() {
            var r = confirm("Are you sure that you want to watch Luxianne's stream?");
            if (r == true) {
                window.open('https://www.picarto.tv/live/channel.php?watch=Luxianne');
            } else {
            }
        }

        function chatLink2() {
            var r = confirm("You will be leaving now Transformania Time. Are you sure about that?");
            if (r == true) {
                window.open('http://goo.gl/forms/Zu0JeZBLn9');
            } else {
            }
        }

        $(function () {
            var chat = $.connection.chatHub;


            chat.client.addNewMessageToPage = function (name, message, chatColor) {

                // if this is not a / command, write out the name and colon.  Otherwise only write the message.
                if (name.length > 0) {
                    $('#discussion ').append('<li><strong>' + htmlEncodeName(name, chatColor) + '</strong>: ' + htmlEncode(message) + '</li>');
                } else {
                    $('#discussion ').append('<li><strong>' + injectColor(chatColor, "start") + htmlEncode(message) + '</span></li>');
                }

                if (autoScrollEnabled == true) {
                    $('#discussion ').animate({ scrollTop: $('#discussion').prop("scrollHeight") }, 500);
                }

                // add onclick to last element
                $('ul#discussion li:last strong:first').dblclick(function () {
                    $('#message').val("@@" + name + "  " + $('#message').val());
                    $('#message').focus();
                });

                if (!document.hasFocus()) {
                    unreadCount++;
                    $(document).attr('title', 'Chat - ' + unreadCount + ' new messages');
                }

                $("#disconnected").hide();

            };

            $('#displayname').val("");
            $('#message').focus();
            $.connection.hub.start().done(function () {
                chat.server.joinRoom("@ViewBag.ChatName");
                chat.state.toRoom = "@ViewBag.ChatName";
                $("#disconnected").hide();
                $(window).focus(function () {
                    $(document).attr('title', 'Chat');
                    unreadCount = 0;
                });

                $('#sendmessage').click(function () {

                    if (clear == true) {
                        chat.server.send($('#displayname').val(), $('#message').val());
                        $('#message').val('').focus();
                    }
                        clear = false;
                    });



            });

            $.connection.hub.disconnected(function () {
                $("#disconnected").show();
                setTimeout(function () {
                    $.connection.hub.start();
                }, 10000); // Restart connection after 5 seconds.
            });

            $(document).keypress(function (e) {
                if (e.which == 13) {

                    if (clear == true) {

                        chat.server.send($('#displayname').val(), $('#message').val());
                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                        clear = false;

                    }


                }

            });

            $(document).click(function () {
                $(document).attr('title', 'Chat');
                unreadCount = 0;
            });

        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            encodedValue = encodedValue.replace("[.[", "<span class='timeago'>");
            encodedValue = encodedValue.replace("].]", "</span>");
            encodedValue = encodedValue.replace("[-[", "<span class='enterMsg'>");
            encodedValue = encodedValue.replace("]-]", "</span>");
            encodedValue = encodedValue.replace("[=[", "<span class='dm'>");
            encodedValue = encodedValue.replace("]=]", "</span>");
            encodedValue = encodedValue.replace("[+[", "<span class='me'>");
            encodedValue = encodedValue.replace("]+]", "</span>");
            encodedValue = encodedValue.replace("Judoo (admin)", "<span class='adminFont'>Judoo (admin)</span>");
            encodedValue = encodedValue.replace("Mizuho (dev)", "<span class='adminFont'>Mizuho (dev)</span>");
            encodedValue = encodedValue.replace(myname, "<span style='background: #FFE9D5; color: " + mynameColor + ";'><strong> " + myname + "</strong></span>");
            encodedValue = encodedValue.replace("[luxa]", "<a onclick='chatLink()'>Luxianne is streaming now</a>");
            encodedValue = encodedValue.replace("[poll]", "Please take part in our Transformation Preferences Poll. <a onclick='chatLink2()'>Transformation Poll - http://goo.gl/forms/Zu0JeZBLn9 </a>");



            return encodedValue;
        }

        function htmlEncodeName(value, nameColor) {


            var encodedValue = $('<div />').text(value).html();

            encodedValue = "<span style='color:" + nameColor + ";'>" + encodedValue + "</span>";


            encodedValue = encodedValue.replace("Judoo (admin)", "<span class='adminFont'>Judoo (admin)</span>");
            encodedValue = encodedValue.replace("Mizuho (dev)", "<span class='adminFont'>Mizuho (dev)</span>");
            encodedValue = encodedValue.replace(myname, "<span style='text-decoration: underline; color: " + mynameColor + ";'><strong> " + myname + "</strong></span>");

            return encodedValue;
        }

        function injectColor(nameColor, startOrEnd) {
            if (startOrEnd == "start") {
                return "<span style='color:" + nameColor + ";'>";
            } else {
                return "</span>";
            }
            
        }

    </script>
}