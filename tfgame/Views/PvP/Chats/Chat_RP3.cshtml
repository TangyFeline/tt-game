@{
    ViewBag.Title = "Chat";
}

<head>
    <link href="~/Content/PvP.css" rel="stylesheet" />
</head>

<h2>RP Room 3</h2>

<p>Welcome to the chat.  This room is meant for group roleplaying.  This page does not save anything, so reloading this page will clear the chat.  A chat log is available for this room @Html.ActionLink("here.", "ChatLog", "PvP", new { room = "rp3", filter = "lasth" }, new { target = "_blank" })  You can view a list of chat commands @Html.ActionLink("here.", "ChatCommands", "PvP", null, new { target = "_blank" })</p>

<p class="bad" id="disconnected" style="display: none;">Your chat is currently disconnected from the server.  It will attempt to automatically reconnect.</p>

<p>
    @Html.ActionLink("Back to game", "Play", "PvP")
    @Html.ActionLink("Global", "Chat", "PvP", new { room = "global" }, null)
    @Html.ActionLink("RP Room 1", "Chat", "PvP", new { room = "rp1" }, null)
    @Html.ActionLink("RP Room 2", "Chat", "PvP", new { room = "rp2" }, null)
</p>

<div class="container">
    <input type="text" id="message" maxlength="500" />
    <input type="button" id="sendmessage" value="Send" />
    <input type="hidden" id="displayname" />
    <ul id="discussion"></ul>
</div>

<p>
    @Html.ActionLink("Back to game", "Play", "PvP")
</p>


@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.0.3.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>

        var clear = true;
        var unreadCount = 0;

        var myname = '@TempData["MyName"]';

        var myVar = setInterval(function () { myTimer() }, 3000);

        function myTimer() {
   
            clear = true;
        }

        $(function () {
            var chat = $.connection.chatHub;
            

            chat.client.addNewMessageToPage = function (name, message) {
                
                $('#discussion ').prepend('<li><strong>' + htmlEncode(name) + '</strong>: ' + htmlEncode(message) + '</li>');

                // add onclick to last element
                $('ul#discussion li:first strong:first').dblclick(function () {
                    $('#message').val("@@" + name + "  " + $('#message').val());
                    $('#message').focus();
                });

                if (!document.hasFocus()) {
                    unreadCount++;
                    $(document).attr('title', 'Chat - ' + unreadCount + ' new messages');
                }

                $("#disconnected").hide();

            };

            $('#displayname').val("");
            $('#message').focus();
            $.connection.hub.start().done(function () {
                chat.server.joinRoom("rp3");
                chat.state.toRoom = "rp3";
                $("#disconnected").hide();
                $(window).focus(function () {
                    $(document).attr('title', 'Chat');
                    unreadCount = 0;
                });

                $('#sendmessage').click(function () {

                    if (clear == true) {
                        chat.server.send($('#displayname').val(), $('#message').val());
                        $('#message').val('').focus();
                    }
                        clear = false;
                    });



            });

            $.connection.hub.disconnected(function () {
                $("#disconnected").show();
                setTimeout(function () {
                    $.connection.hub.start();
                }, 10000); // Restart connection after 5 seconds.
            });

            $(document).keypress(function (e) {
                if (e.which == 13) {

                    if (clear == true) {

                        chat.server.send($('#displayname').val(), $('#message').val());
                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                        clear = false;

                    }
                    
               
                }

            });

            $(document).click(function () {
                $(document).attr('title', 'Chat');
                unreadCount = 0;
            });

        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            encodedValue = encodedValue.replace("[.[", "<span class='timeago'>");
            encodedValue = encodedValue.replace("].]", "</span>");
            encodedValue = encodedValue.replace("[-[", "<span class='enterMsg'>");
            encodedValue = encodedValue.replace("]-]", "</span>");
            encodedValue = encodedValue.replace("[=[", "<span class='dm'>");
            encodedValue = encodedValue.replace("]=]", "</span>");
            encodedValue = encodedValue.replace("Judoo (admin)", "<span class='adminFont'>Judoo (admin)</span>");
            encodedValue = encodedValue.replace("Mizuho (dev)", "<span class='adminFont'>Mizuho (dev)</span>");

            encodedValue = encodedValue.replace(myname, "<span class='youFont'><strong> " + myname + "</strong></span>");
 


            return encodedValue;
        }

        $(window).bind('beforeunload', function() {
            return 'Are you sure you want to leave?';
        });


    </script>



<style>
    #discussion {
        width: 100%;
        height: 500px;
        overflow-y: scroll;
        text-wrap: normal;
        border: 2px solid black;
        border-radius: 8px;
        padding: 5px;
        background-color: #d6f8ff;
    }

        #discussion li {
            padding-top: 4px;
            padding-bottom: 4px;
        }

            #discussion li:nth-child(odd) {
                background-color: #b8dbff;
            }

            #discussion li:nth-child(even) {
                background-color: #d4e9ff;
            }

    .adminFont {
        color: darkred;
    }

    .youFont {
        color: darkblue;
    }

    .dm {
        color: darkgreen;
        font-weight: 800;
    }

    strong {
        cursor: pointer;
    }

        strong:hover {
            color: darkolivegreen;
        }

    body, #body, html {
        background-color: #e5ffed;
    }

    .enterMsg {
        color: black;
        font-weight: 800;
    }
</style>

}